<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Palm Scan Capture and Verification</title>
    <script
      async
      src="https://docs.opencv.org/master/opencv.js"
      onload="onOpenCvReady();"
      onerror="onOpenCvError();"
    ></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f4f4f9;
      }
      #canvas {
        border: 1px solid black;
      }
      #output {
        margin-top: 20px;
        text-align: center;
      }
      video {
        width: 100%;
        max-width: 500px;
        height: auto;
        border: 2px solid #000;
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
        margin-top: 20px;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      #status {
        margin-top: 10px;
        padding: 10px;
        border-radius: 5px;
        display: none;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
    </style>
  </head>
  <body>
    <h1>Capture and Verify Palm Print</h1>

    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas" style="display: none"></canvas>

    <div id="output">
      <div id="status"></div>
      <button id="startCameraButton">Start Camera</button>
      <button id="captureButton" disabled style="display: none">Loading OpenCV...</button>
      <button id="verifyButton" style="display: none">Verify Palm</button>
      <button id="resetButton" style="display: none">Reset</button>
    </div>

    <script>
      let isOpenCvReady = false;
      let capturedImage = null;
      let videoStream = null;
      let capturedKeypoints = null;
      let capturedDescriptors = null;
      let cameraStarted = false;

      function onOpenCvReady() {
        console.log("OpenCV.js is ready");
        isOpenCvReady = true;
        document.getElementById("captureButton").disabled = false;
        document.getElementById("captureButton").textContent = "Capture Palm";
        showStatus("OpenCV loaded successfully. Ready to capture palm.", "success");
      }

      function onOpenCvError() {
        console.error("OpenCV.js failed to load.");
        showStatus("Failed to load OpenCV.js. Please refresh the page.", "error");
      }

      function showStatus(message, type) {
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = message;
        statusDiv.className = type;
        statusDiv.style.display = "block";

        if (type === "success") {
          setTimeout(() => {
            statusDiv.style.display = "none";
          }, 3000);
        }
      }

      function startVideoStream() {
        if (cameraStarted) return;
        navigator.mediaDevices
          .getUserMedia({ video: { facingMode: { ideal: "environment" } }, audio: false })
          .then(function (stream) {
            videoStream = stream;
            const videoElement = document.getElementById("video");
            videoElement.srcObject = stream;
            cameraStarted = true;
            showStatus("Camera started successfully.", "success");
            document.getElementById("captureButton").style.display = "inline-block";
            document.getElementById("startCameraButton").style.display = "none";
          })
          .catch(function (err) {
            console.error("Error accessing the camera: ", err);
            let msg = "Error accessing camera. Please check permissions.";
            if (/(denied|notallowed|permission)/i.test(err.name + err.message)) {
              msg += " Please allow camera access in your browser settings.";
            }
            showStatus(msg, "error");
          });
      }

      function extractFeatures(image) {
        try {
          let gray = new cv.Mat();
          cv.cvtColor(image, gray, cv.COLOR_RGBA2GRAY);

          let orb = new cv.ORB(500);
          let keypoints = new cv.KeyPointVector();
          let descriptors = new cv.Mat();

          orb.detectAndCompute(gray, new cv.Mat(), keypoints, descriptors);

          gray.delete();
          orb.delete();

          return { keypoints, descriptors };
        } catch (error) {
          console.error("Error extracting features:", error);
          return null;
        }
      }

      function capturePalm() {
        if (!isOpenCvReady) {
          showStatus("OpenCV is not ready yet. Please wait.", "error");
          return;
        }

        try {
          const videoElement = document.getElementById("video");
          const canvas = document.getElementById("canvas");
          const ctx = canvas.getContext("2d");

          canvas.width = videoElement.videoWidth;
          canvas.height = videoElement.videoHeight;
          ctx.drawImage(videoElement, 0, 0);

          capturedImage = cv.imread(canvas);

          const features = extractFeatures(capturedImage);
          if (features && features.descriptors.rows > 0) {
            capturedKeypoints = features.keypoints;
            capturedDescriptors = features.descriptors;

            showStatus(
              `Palm captured successfully! Found ${features.keypoints.size()} feature points.`,
              "success"
            );

            document.getElementById("verifyButton").style.display = "inline-block";
            document.getElementById("resetButton").style.display = "inline-block";
            document.getElementById("captureButton").style.display = "none";
          } else {
            showStatus(
              "Could not detect enough features in palm. Try adjusting lighting or position.",
              "error"
            );
          }
        } catch (error) {
          console.error("Error during capture:", error);
          showStatus("Error during capture. Please try again.", "error");
        }
      }

      function verifyPalm() {
        if (!isOpenCvReady || !capturedImage) {
          showStatus("No captured palm to verify against.", "error");
          return;
        }

        try {
          const videoElement = document.getElementById("video");
          const canvas = document.getElementById("canvas");
          const ctx = canvas.getContext("2d");

          canvas.width = videoElement.videoWidth;
          canvas.height = videoElement.videoHeight;
          ctx.drawImage(videoElement, 0, 0);

          const newScan = cv.imread(canvas);

          const newFeatures = extractFeatures(newScan);

          if (newFeatures && newFeatures.descriptors.rows > 0) {
            const match = matchFeatures(capturedDescriptors, newFeatures.descriptors);

            if (match.isMatch) {
              showStatus(
                `Palm verified! Match confidence: ${match.confidence.toFixed(2)}%`,
                "success"
              );
            } else {
              showStatus(
                `Palm verification failed. Match confidence: ${match.confidence.toFixed(2)}%`,
                "error"
              );
            }
          } else {
            showStatus("Could not detect features in new scan. Try adjusting position.", "error");
          }

          newScan.delete();
          if (newFeatures) {
            newFeatures.keypoints.delete();
            newFeatures.descriptors.delete();
          }
        } catch (error) {
          console.error("Error during verification:", error);
          showStatus("Error during verification. Please try again.", "error");
        }
      }

      function matchFeatures(desc1, desc2) {
        try {
          if (desc1.rows === 0 || desc2.rows === 0) {
            return { isMatch: false, confidence: 0 };
          }

          let matcher = new cv.BFMatcher(cv.NORM_HAMMING, true);
          let matches = new cv.DMatchVector();

          matcher.match(desc1, desc2, matches);

          let goodMatches = 0;
          let totalMatches = matches.size();

          if (totalMatches === 0) {
            matcher.delete();
            matches.delete();
            return { isMatch: false, confidence: 0 };
          }

          const distanceThreshold = 50;
          for (let i = 0; i < totalMatches; i++) {
            if (matches.get(i).distance < distanceThreshold) {
              goodMatches++;
            }
          }

          const confidence = (goodMatches / Math.max(desc1.rows, desc2.rows)) * 100;
          const isMatch = confidence > 15;

          matcher.delete();
          matches.delete();

          return { isMatch, confidence };
        } catch (error) {
          console.error("Error matching features:", error);
          return { isMatch: false, confidence: 0 };
        }
      }

      function resetCapture() {
        if (capturedImage) {
          capturedImage.delete();
          capturedImage = null;
        }
        if (capturedKeypoints) {
          capturedKeypoints.delete();
          capturedKeypoints = null;
        }
        if (capturedDescriptors) {
          capturedDescriptors.delete();
          capturedDescriptors = null;
        }

        document.getElementById("verifyButton").style.display = "none";
        document.getElementById("resetButton").style.display = "none";
        document.getElementById("captureButton").style.display = "inline-block";

        if (videoStream) {
          videoStream.getTracks().forEach((track) => track.stop());
          videoStream = null;
          cameraStarted = false;
        }
        document.getElementById("video").srcObject = null;
        document.getElementById("startCameraButton").style.display = "inline-block";
        document.getElementById("captureButton").style.display = "none";
        showStatus("Ready to capture new palm.", "info");
      }

      document.getElementById("startCameraButton").addEventListener("click", startVideoStream);
      document.getElementById("captureButton").addEventListener("click", capturePalm);
      document.getElementById("verifyButton").addEventListener("click", verifyPalm);
      document.getElementById("resetButton").addEventListener("click", resetCapture);

      document.getElementById("startCameraButton").style.display = "inline-block";
      document.getElementById("captureButton").style.display = "none";
      document.getElementById("verifyButton").style.display = "none";
      document.getElementById("resetButton").style.display = "none";
    </script>
  </body>
</html>
